# Build dotnet core project using Azure Pipelines

# build name format
name: WebApp.${Date:yyyyMMdd}.$(Rev:.r)
pool:
  vmImage: 'ubuntu-16.04'

variables:
  buildConfiguration: 'Release'

# trigger CI build for the following branches
trigger: [ dev ]

# disable CI builds for pull requests for now
pr: none

steps:
- task: DotNetCoreCLI@2
  displayName: Restore NuGet Packages
  inputs:
    command: restore
    projects: Product/WebApp

- task: DotNetCoreCLI@2
  displayName: Compile
  inputs:
    command: build 
    arguments: --configuration $(buildConfiguration)
    projects: Product/WebApp

- task: DotNetCoreCLI@2
  displayName: Prepare Publish Files
  inputs:
    command: publish
    arguments: --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
    projects: Product/WebApp

- task: PublishBuildArtifacts@1
  displayName: Publish Artifacts
  inputs:
    artifactName: 'webapp'
    pathtoPublish: '$(Build.ArtifactStagingDirectory)'

- task: ArchiveFiles@2
  displayName: Archive
  inputs:
    rootFolderOrFile: $(Build.ArtifactStagingDirectory)
    archiveFile: '$(System.ArtifactsDirectory)/webapp-$(Build.BuildId).zip'

- task: AzureRmWebAppDeployment@3
  displayName: Deploy to dev environment
  inputs:
    azureSubscription: 'Digital BT (933642d7-459a-499f-acc7-0d9a14ecf604)'
    WebAppName: 'CareerCircleWebApp'
    Package: '$(System.ArtifactsDirectory)/webapp-$(Build.BuildId).zip'